# weâ€™re generally picking macos-10.15 rather than latest
# because macos-11 is currently much slower
# however we would prefer macos-latest where possible to
# make this CI more resilient to time

on:
  pull_request:
    paths:
      - '*.ts'
      - 'fixtures/**/*.swift'
      - .github/workflows/checks.yml
      - dist/*
concurrency:
  group: ${{ github.head_ref }}
  cancel-in-progress: true
jobs:
  defaults:
    runs-on: macos-10.15
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          working-directory: fixtures/debug

  configurations:
    runs-on: macos-10.15
    strategy:
      matrix:
        configuration:
          - debug
          - release
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          configuration: ${{ matrix.configuration }}
          working-directory: fixtures/${{ matrix.configuration }}
          warnings-as-errors: true
          action: test
          upload-logs: always  # so we can test this feature

  verbosity:
    runs-on: macos-10.15
    strategy:
      matrix:
        verbosity:
          - xcpretty
          - quiet
          - verbose
    steps:
      - uses: actions/checkout@v2
      - uses: ./
        with:
          verbosity: ${{ matrix.verbosity }}
          working-directory: fixtures/debug

  swift:
    name: swift ${{ matrix.swift }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        swift:
          - ~5.0
          - ~5.1
          - ~5.2
          - ~5.3
        os:
          - macos-10.15
        include:
          - swift: ~5.4
            os: macos-11
          - swift: ~5.5
            os: macos-11
    steps:
    - uses: actions/checkout@v2
    - uses: ./
      with:
        swift: ${{ matrix.swift }}
        working-directory: fixtures/swift/${{ matrix.swift }}
        action: build
    - uses: mxcl/get-swift-version@v1
      with:
        requires: ${{ matrix.swift }}

  xcode:
    name: ${{ matrix.platform }} (${{ matrix.action }}, ${{ matrix.xcode }}${{ matrix.codecov && ', cc' || ''}})
    runs-on: ${{ matrix.os || 'macos-11' }}
    strategy:
      matrix:
        platform:
          - iOS
          - tvOS
          - macOS
          - watchOS
        xcode:
          - ^10
          - ^11
          - ^12
          - ^13
        codecov:
          - false
        action:
          - test
        warnings-as-errors:
          - false
        include:
          - xcode: ^10
            os: macos-10.15
          - platform: mac-catalyst
            xcode: ^13
            codecov: false
            action: test
            warnings-as-errors: false
    steps:
    - uses: actions/checkout@v2
    - uses: ./
      with:
        platform: ${{ matrix.platform }}
        xcode: ${{ matrix.xcode }}
        working-directory: fixtures/${{ matrix.platform }}
        code-coverage: ${{ matrix.codecov }}
        action: ${{ matrix.action }}
        warnings-as-errors: ${{ matrix.warnings-as-errors }}

  more-xcode:
    name: ${{ matrix.platform }} (${{ matrix.action }}, ${{ matrix.xcode }}${{ matrix.codecov && ', cc' || ''}}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-10.15
          - macos-11
        platform:
          - watchOS
        xcode:
          - ^12
        codecov:
          - false
        action:
          - build
          - test
        warnings-as-errors:
          - false
    steps:
    - uses: actions/checkout@v2
    - uses: ./
      with:
        platform: ${{ matrix.platform }}
        xcode: ${{ matrix.xcode }}
        working-directory: fixtures/${{ matrix.platform }}
        code-coverage: ${{ matrix.codecov }}
        action: ${{ matrix.action }}
        warnings-as-errors: ${{ matrix.warnings-as-errors }}

  verify-codecov:
    name: ${{ matrix.platform }} (${{ matrix.action }}, ${{ matrix.xcode }}${{ matrix.codecov && ', cc' || ''}}${{ matrix.warnings-as-errors && ', warnings-as-errors' || ''}})
    runs-on: macos-10.15
    strategy:
      matrix:
        platform:
          - macOS
        xcode:
          - ^12
        codecov:
          - true
          - false
        action:
          - build
          - test
        warnings-as-errors:
          - true
          - false
    steps:
    - uses: actions/checkout@v2
    - uses: ./
      with:
        platform: ${{ matrix.platform }}
        xcode: ${{ matrix.xcode }}
        working-directory: fixtures/${{ matrix.platform }}
        code-coverage: ${{ matrix.codecov }}
        action: ${{ matrix.action }}
        warnings-as-errors: ${{ matrix.warnings-as-errors }}

  verify-swift-version:
    name: .swift-version
    runs-on: macos-10.15
    steps:
    - uses: actions/checkout@v2
    - uses: mxcl/get-swift-version@v1
      with:
        requires: '>5.1'
    - uses: ./
      with:
        working-directory: fixtures/dot-swift-version
    - uses: mxcl/get-swift-version@v1
      with:
        requires: ~5.1
